# GitHub Actions Workflow para IUS-DIGITALIS
# 
# PropÃ³sito: Pipeline de integraciÃ³n continua y despliegue automatizado
# Trigger: Push a main, develop, o pull requests
# 
# Correcciones aplicadas:
# 1. Tests unitarios implementados en /tests/test_pipeline.py
# 2. Manejo de dependencias consolidadas desde requirements.txt
# 3. CachÃ© de dependencias para acelerar builds
# 4. Matrix de versiones de Python (3.8, 3.9, 3.10)
# 5. Reporte de cobertura de cÃ³digo

name: IUS-DIGITALIS CI/CD

# Eventos que disparan el workflow
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:

# Variables de entorno globales
env:
  PYTHON_VERSION: 3.9
  CACHE_VERSION: v1

jobs:
  # Job 1: Linting y Formateo
  lint:
    name: Linting y Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cachear dependencias
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-pip-lint-
      
      - name: Instalar herramientas de linting
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 mypy bandit
      
      - name: Ejecutar Black (verificar formateo)
        run: |
          black . --check --diff
        continue-on-error: true
      
      - name: Ejecutar isort (verificar imports)
        run: |
          isort . --check-only --diff
        continue-on-error: true
      
      - name: Ejecutar Flake8 (linting)
        run: |
          # Detener el build si hay errores de sintaxis Python o nombres indefinidos
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Advertencias (no bloquean el build)
          flake8 . --count --max-complexity=10 --max-line-length=100 --statistics || true
      
      - name: AnÃ¡lisis de seguridad con Bandit
        run: |
          bandit -r . -f json -o bandit-report.json || true
        continue-on-error: true
      
      - name: Subir reporte de Bandit
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  # Job 2: Tests en mÃºltiples versiones de Python
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']
        # Excluir combinaciones problemÃ¡ticas
        exclude:
          - os: macos-latest
            python-version: '3.8'
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: Configurar Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cachear dependencias
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/Library/Caches/pip
            ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-test-${{ env.CACHE_VERSION }}-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-test-${{ env.CACHE_VERSION }}-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-test-${{ env.CACHE_VERSION }}-
      
      - name: Instalar dependencias del sistema (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr
      
      - name: Instalar dependencias del sistema (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install tesseract
      
      - name: Instalar dependencias de Python
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist
      
      - name: Crear directorios necesarios
        run: |
          mkdir -p output logs tests
      
      - name: Ejecutar tests con pytest
        env:
          # Variables de entorno para tests (valores de prueba)
          ANTHROPIC_API_KEY: test-key-${{ github.sha }}
          OPENAI_API_KEY: test-key-${{ github.sha }}
          WEB3_PROVIDER_URI: https://test.example.com
        run: |
          pytest tests/ \
            --verbose \
            --cov=. \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=20 \
            --maxfail=5 \
            -n auto
      
      - name: Subir reporte de cobertura a Codecov
        uses: codecov/codecov-action@v3
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}
          fail_ci_if_error: false
      
      - name: Subir reportes de tests
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/

  # Job 3: VerificaciÃ³n de Seguridad de Dependencias
  security:
    name: AnÃ¡lisis de Seguridad
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Instalar Safety
        run: |
          python -m pip install --upgrade pip
          pip install safety
      
      - name: Verificar vulnerabilidades en dependencias
        run: |
          pip install -r requirements.txt
          safety check --json --output safety-report.json || true
        continue-on-error: true
      
      - name: Subir reporte de seguridad
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: safety-security-report
          path: safety-report.json

  # Job 4: Build de DocumentaciÃ³n
  docs:
    name: Build de DocumentaciÃ³n
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Instalar dependencias de documentaciÃ³n
        run: |
          python -m pip install --upgrade pip
          pip install sphinx sphinx-rtd-theme
      
      - name: Build documentaciÃ³n
        run: |
          # Si existe carpeta docs/ con Sphinx
          if [ -d "docs" ]; then
            cd docs
            make html || echo "No se pudo generar documentaciÃ³n"
          else
            echo "Carpeta docs/ no encontrada"
          fi
        continue-on-error: true
      
      - name: Deploy a GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: success()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/_build/html

  # Job 5: Notificaciones
  notify:
    name: Notificar Resultados
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    if: always()
    
    steps:
      - name: Determinar estado del workflow
        id: workflow-status
        run: |
          if [[ "${{ needs.lint.result }}" == "success" ]] && \
             [[ "${{ needs.test.result }}" == "success" ]] && \
             [[ "${{ needs.security.result }}" == "success" ]]; then
            echo "status=âœ… SUCCESS" >> $GITHUB_OUTPUT
            echo "color=28a745" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ FAILURE" >> $GITHUB_OUTPUT
            echo "color=dc3545" >> $GITHUB_OUTPUT
          fi
      
      - name: Resumen del workflow
        run: |
          echo "## ðŸ“Š Resumen del CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Estado final**: ${{ steps.workflow-status.outputs.status }}" >> $GITHUB_STEP_SUMMARY

# Configuraciones adicionales
concurrency:
  # Cancelar workflows anteriores del mismo branch si hay uno nuevo
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Permisos necesarios
permissions:
  contents: read
  pull-requests: write
  checks: write
